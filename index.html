<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- HTML Meta Tags -->
        <title>Domain Data | is-a.dev</title>

        <!-- Stylesheets -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />

        <!-- Scripts -->
        <script src="https://cdn.tailwindcss.com"></script>
    </head>

    <body class="p-4 bg-gray-800 text-white">
        <h1 class="text-2xl font-bold mb-4">is-a.dev Data</h1>

        <hr class="mt-4">

        <h3 class="text-xl font-semibold my-4">Domain Statistics</h3>

        <ul>
            <li><span class="font-semibold">Total Domains</span>: <span id="total-domains">Loading...</span></li>
            <li><span class="font-semibold">Total Records</span>: <span id="total-records">Loading...</span></li>
            <li><span class="font-semibold">Unique Users</span>: <span id="unique-users">Loading...</span></li>
            <li><span class="font-semibold">Average amount of domains per user</span>: <span id="average-domains-per-user">Loading...</span></li>
            <li><span class="font-semibold">User with the most domains</span>: <span id="user-with-most-domains">Loading...</span></li>
            <li><span class="font-semibold">User with the most records</span>: <span id="user-with-most-records">Loading...</span></li>
        </ul>

        <hr class="mt-4">

        <h3 class="text-xl font-semibold my-4">DNS Records</h3>

        <ul>
            <li><span class="font-semibold">A</span>: <span id="a-records">Loading...</span></li>
            <li><span class="font-semibold">AAAA</span>: <span id="aaaa-records">Loading...</span></li>
            <li><span class="font-semibold">CAA</span>: <span id="caa-records">Loading...</span></li>
            <li><span class="font-semibold">CNAME</span>: <span id="cname-records">Loading...</span></li>
            <li><span class="font-semibold">DS</span>: <span id="ds-records">Loading...</span></li>
            <li><span class="font-semibold">MX</span>: <span id="mx-records">Loading...</span></li>
            <li><span class="font-semibold">NS</span>: <span id="ns-records">Loading...</span></li>
            <li><span class="font-semibold">SRV</span>: <span id="srv-records">Loading...</span></li>
            <li><span class="font-semibold">TXT</span>: <span id="txt-records">Loading...</span></li>
            <li><span class="font-semibold">URL</span>: <span id="url-records">Loading...</span></li>
        </ul>

        <hr class="mt-4">

        <footer class="mt-4">
            <p><span class="font-semibold">Zone last updated</span>: <span id="zone-updated">Loading...</span></p>
        </footer>

        <script>
            fetch("https://raw-api.is-a.dev")
                .then((response) => response.json())
                .then((data) => {
                    const domainData = JSON.parse(localStorage.getItem("domainData"));
                    const formattedData = JSON.parse(localStorage.getItem("formattedData"));

                    // Check if cache exists
                    if (JSON.stringify(domainData) === JSON.stringify(data) && formattedData) {
                        document.getElementById("total-domains").innerText = formattedData.totalDomains;
                        document.getElementById("total-records").innerText = formattedData.totalRecords;
                        document.getElementById("unique-users").innerText = formattedData.uniqueUsers;
                        document.getElementById("average-domains-per-user").innerText = formattedData.averageDomainsPerUser;
                        document.getElementById("user-with-most-domains").innerText = formattedData.userWithMostDomains;
                        document.getElementById("user-with-most-records").innerText = formattedData.userWithMostRecords;
                        document.getElementById("a-records").innerText = formattedData.A;
                        document.getElementById("aaaa-records").innerText = formattedData.AAAA;
                        document.getElementById("caa-records").innerText = formattedData.CAA;
                        document.getElementById("cname-records").innerText = formattedData.CNAME;
                        document.getElementById("ds-records").innerText = formattedData.DS;
                        document.getElementById("mx-records").innerText = formattedData.MX;
                        document.getElementById("ns-records").innerText = formattedData.NS;
                        document.getElementById("srv-records").innerText = formattedData.SRV;
                        document.getElementById("txt-records").innerText = formattedData.TXT;
                        document.getElementById("url-records").innerText = formattedData.URL;
                        return;
                    } else {
                        localStorage.removeItem("domainData");
                        localStorage.removeItem("formattedData");

                        localStorage.setItem("domainData", JSON.stringify(data));
                    }

                    // Cache domain data
                    localStorage.setItem("domainData", JSON.stringify(data));
                    let totalDomains = data.length;
                    let totalRecords = 0;
                    let uniqueUsers = [...new Set(data.map((domain) => domain.owner.username))].length;
                    let averageDomainsPerUser = (totalDomains / uniqueUsers).toFixed(1);
                    let userWithMostDomains = [...new Set(data.map((domain) => domain.owner.username))].reduce((a, b) => data.filter((domain) => domain.owner.username === a).length >= data.filter((domain) => domain.owner.username === b).length ? a : b);
                    let userWithMostRecords = [...new Set(data.map((domain) => domain.owner.username))].reduce((a, b) => data.filter((domain) => domain.owner.username === a).reduce((acc, domain) => acc + Object.keys(domain.record).length, 0) >= data.filter((domain) => domain.owner.username === b).reduce((acc, domain) => acc + Object.keys(domain.record).length, 0) ? a : b);

                    let A = 0;
                    let AAAA = 0;
                    let CAA = 0;
                    let CNAME = 0;
                    let DS = 0;
                    let MX = 0;
                    let NS = 0;
                    let SRV = 0;
                    let TXT = 0;
                    let URL = 0;

                    for (const domain of data) {
                        if(domain.record.A) {
                            for (const record of domain.record.A) {
                                A++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.AAAA) {
                            for (const record of domain.record.AAAA) {
                                AAAA++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.CAA) {
                            for (const record of domain.record.CAA) {
                                CAA++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.CNAME) {
                            CNAME++;
                            totalRecords++;
                        }

                        if(domain.record.DS) {
                            DS++;
                            totalRecords++;
                        }

                        if(domain.record.MX) {
                            for (const record of domain.record.MX) {
                                MX++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.NS) {
                            for (const record of domain.record.NS) {
                                NS++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.SRV) {
                            for (const record of domain.record.SRV) {
                                SRV++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.TXT) {
                            if (Array.isArray(domain.record.TXT)) {
                                for (const record of domain.record.TXT) {
                                    TXT++;
                                    totalRecords++;
                                }
                            } else {
                                TXT++;
                                totalRecords++;
                            }
                        }

                        if(domain.record.URL) {
                            URL++;
                            totalRecords++;
                        }
                    }

                    document.getElementById("total-domains").innerText = totalDomains;
                    document.getElementById("total-records").innerText = totalRecords;
                    document.getElementById("unique-users").innerText = uniqueUsers;
                    document.getElementById("average-domains-per-user").innerText = averageDomainsPerUser;
                    document.getElementById("user-with-most-domains").innerText = userWithMostDomains;
                    document.getElementById("user-with-most-records").innerText = userWithMostRecords;
                    document.getElementById("a-records").innerText = A;
                    document.getElementById("aaaa-records").innerText = AAAA;
                    document.getElementById("caa-records").innerText = CAA;
                    document.getElementById("cname-records").innerText = CNAME;
                    document.getElementById("ds-records").innerText = DS;
                    document.getElementById("mx-records").innerText = MX;
                    document.getElementById("ns-records").innerText = NS;
                    document.getElementById("srv-records").innerText = SRV;
                    document.getElementById("txt-records").innerText = TXT;
                    document.getElementById("url-records").innerText = URL;

                    // Cache formatted data
                    localStorage.setItem("formattedData", JSON.stringify({
                        totalDomains,
                        totalRecords,
                        uniqueUsers,
                        averageDomainsPerUser,
                        userWithMostDomains,
                        userWithMostRecords,
                        A,
                        AAAA,
                        CAA,
                        CNAME,
                        DS,
                        MX,
                        NS,
                        SRV,
                        TXT,
                        URL
                    }));
                });

            fetch("https://api.hrsn.net/is-a-dev/zone-updated")
                .then((response) => response.json())
                .then((data) => {
                    document.getElementById("zone-updated").innerText = data.timestamp.rfc;
                });
        </script>
    </body>
</html>
